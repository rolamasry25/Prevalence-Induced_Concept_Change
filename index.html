<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Concept Classification Test</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background: #f4f4f4;
      margin: 0;
      flex-direction: column;
    }
    .dot {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      margin: 30px auto;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .button-group button {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      border-radius: 8px;
      margin: 10px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    .button-group button:hover {
      background-color: #0056b3;
    }
    .hidden { display: none; }
    canvas { margin-top: 30px; }
    #dashboardBtn {
      background: #28a745;
      padding: 10px 20px;
      color: #fff;
      border-radius: 6px;
      border: none;
      margin-top: 30px;
      cursor: pointer;
    }
    .dashboard-section {
      background: #fff;
      padding: 2rem;
      border-radius: 10px;
      margin: 20px;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
  <h1>Prevalence-Induced Concept Change</h1>
  <div id="experiment">
    <button onclick="startExperiment()">Start</button>
  </div>
  <button id="dashboardBtn" onclick="showDashboard()">View Dashboard</button>
  <canvas id="resultChart" class="hidden" width="400" height="200"></canvas>
  <div id="dashboard" class="hidden dashboard-section"></div>

  <script>
    const baseColors = [
      { name: "blue", code: "#0000FF", category: true },
      { name: "royalblue", code: "#4169E1", category: true },
      { name: "mediumslateblue", code: "#7B68EE", category: true },
      { name: "blueviolet", code: "#8A2BE2", category: false },
      { name: "mediumorchid", code: "#BA55D3", category: false },
      { name: "purple", code: "#800080", category: false }
    ];

    let trials = [];
    let currentIndex = 0;
    let block = 'Baseline';

    function startExperiment() {
      trials = [];
      currentIndex = 0;
      block = 'Baseline';
      document.getElementById('resultChart').classList.add('hidden');
      document.getElementById('dashboard').classList.add('hidden');
      showNext();
    }

    function showNext() {
      if (currentIndex >= 60) {
        showChart();
        return;
      }

      if (currentIndex === 30) block = 'Low Prevalence';

      let stimulus;
      if (block === 'Baseline') {
        stimulus = baseColors[Math.floor(Math.random() * 6)];
      } else {
        // 10% blue in low prevalence
        stimulus = Math.random() < 0.1 ? baseColors[Math.floor(Math.random() * 3)] : baseColors[Math.floor(Math.random() * 3) + 3];
      }

      const container = document.getElementById('experiment');
      container.innerHTML = `
        <div class="dot" style="background-color: ${stimulus.code};"></div>
        <div class="button-group">
          <button onclick="recordResponse(true, '${stimulus.name}', ${stimulus.category}, '${block}')">Blue</button>
          <button onclick="recordResponse(false, '${stimulus.name}', ${stimulus.category}, '${block}')">Not Blue</button>
        </div>
        <p><strong>Block:</strong> ${block}<br><strong>Trial ${currentIndex + 1} of 60</strong></p>
      `;
    }

    function recordResponse(userResponse, colorName, isBlue, blockType) {
      trials.push({
        color: colorName,
        isBlue: isBlue,
        response: userResponse,
        correct: userResponse === isBlue,
        block: blockType,
        timestamp: new Date().toISOString()
      });
      currentIndex++;
      showNext();
    }

    function showChart() {
      const container = document.getElementById('experiment');
      container.innerHTML = `<p>Experiment complete! See results below.</p>`;
      const ctx = document.getElementById('resultChart');
      document.getElementById('resultChart').classList.remove('hidden');

      const blocks = { Baseline: [], "Low Prevalence": [] };
      trials.forEach(t => blocks[t.block].push(t.correct));

      const baselineAcc = (blocks.Baseline.filter(x => x).length / blocks.Baseline.length) * 100;
      const lowAcc = (blocks["Low Prevalence"].filter(x => x).length / blocks["Low Prevalence"].length) * 100;

      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['Baseline (50% Blue)', 'Low Prevalence (10% Blue)'],
          datasets: [{
            label: 'Accuracy (%)',
            data: [baselineAcc, lowAcc],
            backgroundColor: ['#007bff', '#800080']
          }]
        },
        options: {
          scales: { y: { beginAtZero: true, max: 100 } },
          plugins: { legend: { display: false } }
        }
      });

      // Save results to localStorage or optionally send to backend later
      const saved = localStorage.getItem('concept_trials') || "[]";
      const all = JSON.parse(saved);
      all.push(trials);
      localStorage.setItem('concept_trials', JSON.stringify(all));
    }

    function showDashboard() {
      const all = JSON.parse(localStorage.getItem('concept_trials') || "[]");
      if (all.length === 0) {
        alert("No data available yet.");
        return;
      }
      let baselineCorrect = 0, lowCorrect = 0, baselineTotal = 0, lowTotal = 0;

      all.forEach(session => {
        session.forEach(t => {
          if (t.block === 'Baseline') {
            baselineTotal++;
            if (t.correct) baselineCorrect++;
          } else {
            lowTotal++;
            if (t.correct) lowCorrect++;
          }
        });
      });

      const accBaseline = (baselineCorrect / baselineTotal * 100).toFixed(1);
      const accLow = (lowCorrect / lowTotal * 100).toFixed(1);
      const dashboard = document.getElementById("dashboard");
      dashboard.classList.remove("hidden");
      dashboard.innerHTML = `
        <h2>Dashboard</h2>
        <p>Total Sessions: ${all.length}</p>
        <p>Baseline Accuracy: ${accBaseline}%</p>
        <p>Low Prevalence Accuracy: ${accLow}%</p>
        <button onclick="exportCSV()">Export All Data (CSV)</button>
      `;
    }

    function exportCSV() {
      const all = JSON.parse(localStorage.getItem('concept_trials') || "[]");
      const rows = [['SessionID','Color','IsBlue','Response','Correct','Block','Timestamp']];
      all.forEach((session, index) => {
        session.forEach(trial => {
          rows.push([
            index + 1,
            trial.color,
            trial.isBlue,
            trial.response,
            trial.correct,
            trial.block,
            trial.timestamp
          ]);
        });
      });
      const csvContent = "data:text/csv;charset=utf-8," + rows.map(e => e.join(",")).join("\n");
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "concept_change_data.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
  </script>
</body>
</html>
